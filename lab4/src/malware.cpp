#include <cpen333/process/subprocess.h>
#include <cpen333/process/shared_memory.h>
#include <chrono>
#include <thread>
#include <string>
#include <iostream>

struct MalwareInfo {
  int counter[2];
};

// Usage:
//    malware <name> <index>
// name is any name
// index is 0 or 1
// defaults to name:malware, index:0
int main(int argc, char* argv[]) {

  // extract name and index
  int index = 0;
  std::string name = "malware";
  if (argc > 1) {
    name = argv[1];
  }
  if (argc > 2) {
    index = std::atoi(argv[2]);
  }

  std::cout << name << " " << std::to_string(index)  << " started" << std::endl;

  cpen333::process::shared_object<MalwareInfo> memory("lab4_malware");
  cpen333::process::mutex mutex("lab4_malware_mutex");
  {
    std::lock_guard<decltype(mutex)> lock(mutex);
    memory->counter[index] = 1;
  }

  int oindex = (index + 1) % 2;  // index of other malware process
  int last_counter;
  while (true) {

    std::cout << name << " " << std::to_string(index)  << " running" << std::endl;

    int other_counter;
    {
      std::lock_guard<decltype(mutex)> lock(mutex);
      other_counter = memory->counter[oindex];
      memory->counter[index]++;
    }

    // if counter of other process has not incremented
    // reopen a malware process
    if (last_counter == other_counter) {
      std::cout << "Other process has not checked in. Starting..." << std::endl;
      std::vector<std::string> args;
      args.push_back("./bin/malware");
      args.push_back("malware " + std::to_string(oindex));
      args.push_back(std::to_string(oindex));
      cpen333::process::subprocess malware(args, true, true);

      last_counter = 0;
    } else {
      last_counter = other_counter;
    }
    
    std::cout << std::endl;
    std::this_thread::sleep_for(std::chrono::seconds(10));
  }

  return 0;
}